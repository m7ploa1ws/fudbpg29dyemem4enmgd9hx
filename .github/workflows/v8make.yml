name: Build V8 for View8

on:
  workflow_dispatch:
    inputs:
      v8_version:
        description: 'V8 Version Tag (e.g., 10.6.194.27)'
        required: true
        default: '10.6.194.27'
      pointer_compression:
        description: 'Enable Pointer Compression (True for Electron/Node > 14)'
        required: true
        type: boolean
        default: true
      sandbox:
        description: 'Enable V8 Sandbox (Usually True for newer Electron)'
        required: true
        type: boolean
        default: true

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Configure Git
      shell: powershell
      run: |
        # 修复 Git 配置报错的问题
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global core.autocrlf false
        git config --global core.filemode false
        # 告诉 depot_tools 不要以此再次修改配置
        git config --global depot-tools.allowGlobalGitConfig false

    - name: Install depot_tools
      shell: powershell
      run: |
        Invoke-WebRequest -Uri "https://storage.googleapis.com/chrome-infra/depot_tools.zip" -OutFile "depot_tools.zip"
        Expand-Archive -Path "depot_tools.zip" -DestinationPath "C:\depot_tools" -Force
        echo "C:\depot_tools" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "DEPOT_TOOLS_WIN_TOOLCHAIN=0" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Update depot_tools
      shell: powershell
      run: |
        $env:Path = "C:\depot_tools;" + $env:Path
        # 显式运行一次 update
        gclient --version

    - name: Fetch V8 Source Code (Step-by-Step)
      shell: powershell
      run: |
        $env:Path = "C:\depot_tools;" + $env:Path
        mkdir v8_build
        cd v8_build
        
        # 1. 初始化 gclient
        gclient config --name=v8 "https://chromium.googlesource.com/v8/v8.git"
        
        # 2. 先同步最新的 HEAD (浅克隆)，建立基础目录结构
        #    这里不指定版本，防止找不到 ref 报错
        echo "Step 1: Syncing HEAD..."
        gclient sync --no-history --shallow
        
        cd v8
        # 3. 显式 Fetch 指定的 Tag
        #    使用完整的 refspec: refs/tags/xxx，确保 Git 能找到它
        $tag = "${{ inputs.v8_version }}"
        echo "Step 2: Fetching tag refs/tags/$tag..."
        git fetch origin refs/tags/$tag`:refs/tags/$tag --depth=1
        
        # 4. 切换到该 Tag
        echo "Step 3: Checkout $tag..."
        git checkout $tag
        
        cd ..
        # 5. 同步该版本的依赖库 (Dependencies)
        #    -D 参数会移除未在 DEPS 文件中定义的依赖，确保环境纯净
        echo "Step 4: Syncing dependencies..."
        gclient sync -D

    - name: Generate Build Files (GN)
      shell: powershell
      working-directory: v8_build/v8
      run: |
        $env:Path = "C:\depot_tools;" + $env:Path
        
        $pointer_compression = "${{ inputs.pointer_compression }}" -eq "true" ? "true" : "false"
        $sandbox = "${{ inputs.sandbox }}" -eq "true" ? "true" : "false"
        
        echo "Building with Pointer Compression: $pointer_compression"
        
        $args = @"
        is_debug = false
        target_cpu = ""x64""
        is_component_build = false
        v8_static_library = true
        v8_enable_pointer_compression = $pointer_compression
        v8_enable_sandbox = $sandbox
        v8_enable_i18n_support = true
        treat_warnings_as_errors = false
        dcheck_always_on = false
        "@
        
        gn gen out/release --args="$args"

    - name: Compile d8 (Ninja)
      shell: powershell
      working-directory: v8_build/v8
      run: |
        $env:Path = "C:\depot_tools;" + $env:Path
        ninja -C out/release d8

    - name: Rename and Prepare Artifact
      shell: powershell
      working-directory: v8_build/v8/out/release
      run: |
        $suffix = "${{ inputs.pointer_compression }}" -eq "true" ? "pc_on" : "pc_off"
        # 复制 d8.exe 并重命名
        Copy-Item d8.exe -Destination "v8_${{ inputs.v8_version }}_${suffix}.exe"
        
        # 某些版本可能还需要这两个文件，一并打包以防万一
        if (Test-Path icu_data.bin) { Copy-Item icu_data.bin -Destination "icu_data.bin" }
        if (Test-Path snapshot_blob.bin) { Copy-Item snapshot_blob.bin -Destination "snapshot_blob.bin" }

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: v8-binary-${{ inputs.v8_version }}-${{ inputs.pointer_compression }}
        path: |
            v8_build/v8/out/release/v8_*.exe
            v8_build/v8/out/release/*.bin
